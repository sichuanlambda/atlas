<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zoning Data Explorer ‚Äî Atlas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Georgia', serif; background: #f4f1eb; color: #2c3e50; }
    
    #header {
      background: #2c3e50;
      color: #f4f1eb;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #header h1 { font-size: 1.4em; font-weight: 400; letter-spacing: 1px; }
    #header a { color: #a8c5d6; text-decoration: none; font-size: 0.85em; }
    #header a:hover { color: #fff; }
    
    #controls {
      background: #fff;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }
    #controls label { font-size: 0.85em; font-weight: 600; color: #555; white-space: nowrap; }
    #controls select, #controls input[type="text"] {
      padding: 7px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85em;
      background: #fff;
    }
    #city-select { min-width: 220px; }
    #zone-filter { min-width: 180px; }
    #zone-search { min-width: 160px; }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .filter-divider {
      width: 1px;
      height: 28px;
      background: #ddd;
      margin: 0 4px;
    }
    #clear-filter {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f8f8f8;
      cursor: pointer;
      font-size: 0.8em;
      color: #666;
      font-family: inherit;
    }
    #clear-filter:hover { background: #eee; border-color: #aaa; }
    #clear-filter.active { background: #e74c3c; color: white; border-color: #c0392b; }
    #status {
      font-size: 0.82em;
      color: #888;
      margin-left: auto;
      white-space: nowrap;
    }
    .filter-hidden { display: none !important; }
    
    #zone-info {
      background: #2c3e50;
      color: #f4f1eb;
      padding: 8px 16px;
      font-size: 0.9em;
      min-height: 36px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #zone-info .zone-code {
      background: rgba(255,255,255,0.15);
      padding: 2px 10px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 1.1em;
      letter-spacing: 1px;
    }
    .zone-highlight {
      background: #f39c12;
      color: #000;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.8em;
      font-weight: 600;
    }
    
    #map { height: calc(100vh - 140px); width: 100%; }
    
    .legend {
      background: white;
      padding: 10px 14px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.8em;
      line-height: 1.6;
    }
    .legend h4 { margin-bottom: 6px; font-size: 0.9em; color: #333; }
    .legend-item { display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 1px 0; border-radius: 3px; }
    .legend-item:hover { background: #f0f0f0; }
    .legend-item.active { background: #fff3cd; font-weight: 600; }
    .legend-color {
      width: 16px; height: 12px; border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.2); flex-shrink: 0;
    }
    
    .loading-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(244,241,235,0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; font-size: 1.2em; color: #555;
    }
    .loading-overlay.hidden { display: none; }

    @media (max-width: 700px) {
      #controls { padding: 8px 12px; gap: 8px; }
      #header h1 { font-size: 1.1em; }
      #city-select, #zone-filter, #zone-search { min-width: 140px; }
      .filter-divider { display: none; }
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>üó∫Ô∏è Zoning Data Explorer</h1>
    <a href="index.html">‚Üê Atlas Dashboard</a>
  </div>
  
  <div id="controls">
    <div class="filter-group">
      <label for="city-select">City:</label>
      <select id="city-select">
        <option value="">Select a city‚Ä¶</option>
      </select>
    </div>
    
    <div class="filter-divider"></div>
    
    <div class="filter-group filter-hidden" id="zone-filter-group">
      <label for="zone-filter">Zone:</label>
      <select id="zone-filter">
        <option value="">All zones</option>
      </select>
      <input type="text" id="zone-search" placeholder="Search zones‚Ä¶" />
      <button id="clear-filter">Clear</button>
    </div>
    
    <span id="status"></span>
  </div>
  
  <div id="zone-info">
    <span>Click a zone on the map to see details</span>
  </div>
  
  <div style="position: relative;">
    <div id="loading" class="loading-overlay hidden">Loading zoning data‚Ä¶</div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const COLORS = [
      '#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#42d4f4',
      '#f032e6','#bfef45','#fabed4','#469990','#dcbeff','#9A6324','#fffac8',
      '#800000','#aaffc3','#808000','#ffd8b1','#000075','#a9a9a9','#e6beff',
      '#1abc9c','#2ecc71','#3498db','#9b59b6','#e74c3c','#f39c12','#1f77b4',
      '#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f',
      '#bcbd22','#17becf','#aec7e8','#ffbb78','#98df8a','#ff9896'
    ];

    let map, currentLayer, legend, cities = [];
    let currentGeojson = null;
    let currentCity = null;
    let colorMap = {};
    let allZoneCodes = [];
    let activeFilter = '';

    // Init map
    map = L.map('map').setView([37.0, -95.7], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      maxZoom: 19
    }).addTo(map);

    // Load city list
    fetch('zoning/cities.json')
      .then(r => r.json())
      .then(data => {
        cities = data.sort((a, b) => a.name.localeCompare(b.name));
        const select = document.getElementById('city-select');
        cities.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.slug;
          opt.textContent = `${c.name}, ${c.state} (${c.zones.toLocaleString()} zones)`;
          select.appendChild(opt);
        });
      });

    // City selection
    document.getElementById('city-select').addEventListener('change', function() {
      const slug = this.value;
      if (!slug) return;
      loadCity(slug);
    });

    // Zone filter dropdown
    document.getElementById('zone-filter').addEventListener('change', function() {
      applyFilter(this.value);
    });

    // Zone search ‚Äî filters the dropdown options and also applies as text filter
    document.getElementById('zone-search').addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      const select = document.getElementById('zone-filter');
      
      // Filter dropdown options
      Array.from(select.options).forEach(opt => {
        if (opt.value === '') { opt.style.display = ''; return; }
        opt.style.display = opt.value.toLowerCase().includes(query) ? '' : 'none';
      });
      
      // If there's a query, apply a text-based filter across all matching zones
      if (query.length >= 1) {
        const matchingZones = allZoneCodes.filter(z => z.toLowerCase().includes(query));
        applyMultiFilter(matchingZones, query);
      } else {
        applyFilter('');
      }
    });

    // Clear button
    document.getElementById('clear-filter').addEventListener('click', function() {
      document.getElementById('zone-filter').value = '';
      document.getElementById('zone-search').value = '';
      // Reset dropdown option visibility
      Array.from(document.getElementById('zone-filter').options).forEach(opt => opt.style.display = '');
      applyFilter('');
    });

    function loadCity(slug) {
      const city = cities.find(c => c.slug === slug);
      if (!city) return;
      currentCity = city;

      const loading = document.getElementById('loading');
      const status = document.getElementById('status');
      loading.classList.remove('hidden');
      status.textContent = `Loading ${city.name}‚Ä¶ (${(city.sizeKb/1024).toFixed(1)} MB)`;

      // Clear previous
      if (currentLayer) { map.removeLayer(currentLayer); }
      if (legend) { map.removeControl(legend); }
      activeFilter = '';
      document.getElementById('zone-filter').value = '';
      document.getElementById('zone-search').value = '';

      fetch(`zoning/${slug}.geojson`)
        .then(r => r.json())
        .then(geojson => {
          currentGeojson = geojson;
          
          // Build zone‚Üícolor map
          allZoneCodes = [...new Set(geojson.features.map(f => f.properties.z || 'Unknown'))].sort();
          colorMap = {};
          allZoneCodes.forEach((code, i) => {
            colorMap[code] = COLORS[i % COLORS.length];
          });

          // Populate zone filter dropdown with this city's zones
          populateZoneFilter(allZoneCodes);
          
          // Show filter controls
          document.getElementById('zone-filter-group').classList.remove('filter-hidden');

          // Render
          renderLayer(geojson, '');

          // Fly to city
          map.flyTo(city.center, city.zones > 20000 ? 10 : 12, { duration: 1 });

          // Legend
          renderLegend(allZoneCodes);

          loading.classList.add('hidden');
          status.textContent = `${city.name}: ${geojson.features.length.toLocaleString()} zones, ${allZoneCodes.length} types`;
        })
        .catch(err => {
          loading.classList.add('hidden');
          status.textContent = `Error loading ${city.name}: ${err.message}`;
        });
    }

    function populateZoneFilter(zoneCodes) {
      const select = document.getElementById('zone-filter');
      // Clear existing options except first
      select.innerHTML = '<option value="">All zones (' + zoneCodes.length + ')</option>';
      
      // Count features per zone for the label
      const counts = {};
      if (currentGeojson) {
        currentGeojson.features.forEach(f => {
          const z = f.properties.z || 'Unknown';
          counts[z] = (counts[z] || 0) + 1;
        });
      }
      
      zoneCodes.forEach(code => {
        const opt = document.createElement('option');
        opt.value = code;
        const count = counts[code] || 0;
        opt.textContent = `${code || '(empty)'} (${count})`;
        select.appendChild(opt);
      });
    }

    function renderLayer(geojson, filterZone) {
      if (currentLayer) { map.removeLayer(currentLayer); }
      
      const isFiltered = filterZone !== '';
      let visibleCount = 0;
      
      currentLayer = L.geoJSON(geojson, {
        style: function(feature) {
          const zone = feature.properties.z || 'Unknown';
          const isMatch = !isFiltered || zone === filterZone;
          return {
            fillColor: isMatch ? colorMap[zone] : '#ddd',
            fillOpacity: isMatch ? 0.65 : 0.1,
            color: isMatch ? '#333' : '#ccc',
            weight: isMatch ? 0.8 : 0.2,
            opacity: isMatch ? 0.7 : 0.2
          };
        },
        onEachFeature: function(feature, layer) {
          const zone = feature.properties.z || 'Unknown';
          const isMatch = !isFiltered || zone === filterZone;
          if (isMatch) visibleCount++;
          
          layer.on('click', function() {
            document.getElementById('zone-info').innerHTML = 
              `<span class="zone-code">${zone}</span> <span>${currentCity.name}, ${currentCity.state}</span>` +
              (isFiltered && isMatch ? ' <span class="zone-highlight">Filtered</span>' : '');
            
            // Also set the filter to this zone on click
            if (!isFiltered) {
              document.getElementById('zone-filter').value = zone;
            }
          });
          layer.on('mouseover', function() {
            if (isMatch || !isFiltered) {
              this.setStyle({ weight: 2, fillOpacity: isMatch ? 0.85 : 0.4 });
            }
          });
          layer.on('mouseout', function() {
            currentLayer.resetStyle(this);
          });
        }
      }).addTo(map);

      // Update status
      const status = document.getElementById('status');
      if (isFiltered) {
        const totalFeatures = geojson.features.filter(f => (f.properties.z || 'Unknown') === filterZone).length;
        status.textContent = `${currentCity.name}: showing ${totalFeatures.toLocaleString()} "${filterZone}" zones (${allZoneCodes.length} types total)`;
        document.getElementById('clear-filter').classList.add('active');
      } else {
        status.textContent = `${currentCity.name}: ${geojson.features.length.toLocaleString()} zones, ${allZoneCodes.length} types`;
        document.getElementById('clear-filter').classList.remove('active');
      }
    }

    function renderMultiLayer(geojson, matchingZones) {
      if (currentLayer) { map.removeLayer(currentLayer); }
      
      const matchSet = new Set(matchingZones);
      
      currentLayer = L.geoJSON(geojson, {
        style: function(feature) {
          const zone = feature.properties.z || 'Unknown';
          const isMatch = matchSet.has(zone);
          return {
            fillColor: isMatch ? colorMap[zone] : '#ddd',
            fillOpacity: isMatch ? 0.65 : 0.1,
            color: isMatch ? '#333' : '#ccc',
            weight: isMatch ? 0.8 : 0.2,
            opacity: isMatch ? 0.7 : 0.2
          };
        },
        onEachFeature: function(feature, layer) {
          const zone = feature.properties.z || 'Unknown';
          const isMatch = matchSet.has(zone);
          
          layer.on('click', function() {
            document.getElementById('zone-info').innerHTML = 
              `<span class="zone-code">${zone}</span> <span>${currentCity.name}, ${currentCity.state}</span>` +
              (isMatch ? ' <span class="zone-highlight">Match</span>' : '');
          });
          layer.on('mouseover', function() {
            if (isMatch) this.setStyle({ weight: 2, fillOpacity: 0.85 });
          });
          layer.on('mouseout', function() {
            currentLayer.resetStyle(this);
          });
        }
      }).addTo(map);

      const matchCount = geojson.features.filter(f => matchSet.has(f.properties.z || 'Unknown')).length;
      document.getElementById('status').textContent = 
        `${currentCity.name}: ${matchCount.toLocaleString()} zones matching (${matchingZones.length} types), ${allZoneCodes.length} total types`;
      document.getElementById('clear-filter').classList.add('active');
    }

    function applyFilter(zone) {
      activeFilter = zone;
      if (!currentGeojson) return;
      renderLayer(currentGeojson, zone);
      renderLegend(allZoneCodes, zone);
    }

    function applyMultiFilter(matchingZones, query) {
      if (!currentGeojson) return;
      if (matchingZones.length === 0) {
        renderLayer(currentGeojson, '__none__');
        document.getElementById('status').textContent = `${currentCity.name}: no zones matching "${query}"`;
        return;
      }
      if (matchingZones.length === allZoneCodes.length) {
        renderLayer(currentGeojson, '');
        return;
      }
      renderMultiLayer(currentGeojson, matchingZones);
      renderLegend(allZoneCodes, '', matchingZones);
    }

    function renderLegend(zoneCodes, singleFilter, multiFilter) {
      if (legend) { map.removeControl(legend); }
      
      const matchSet = multiFilter ? new Set(multiFilter) : null;
      
      legend = L.control({ position: 'bottomright' });
      legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        
        // If filtered, show filtered zones first
        let displayCodes = zoneCodes;
        if (singleFilter) {
          displayCodes = [singleFilter, ...zoneCodes.filter(c => c !== singleFilter)];
        } else if (matchSet) {
          const matched = zoneCodes.filter(c => matchSet.has(c));
          const unmatched = zoneCodes.filter(c => !matchSet.has(c));
          displayCodes = [...matched, ...unmatched];
        }
        
        const filterLabel = singleFilter ? ` ‚Äî filtered: ${singleFilter}` : 
                           matchSet ? ` ‚Äî ${matchSet.size} matching` : '';
        div.innerHTML = `<h4>${currentCity?.name || ''} (${zoneCodes.length})${filterLabel}</h4>`;
        
        const show = displayCodes.slice(0, 40);
        show.forEach(code => {
          const isActive = singleFilter === code || (matchSet && matchSet.has(code));
          const isDimmed = (singleFilter && singleFilter !== code) || (matchSet && !matchSet.has(code));
          
          const item = document.createElement('div');
          item.className = 'legend-item' + (isActive ? ' active' : '');
          item.style.opacity = isDimmed ? '0.4' : '1';
          item.innerHTML = `<span class="legend-color" style="background:${colorMap[code]}"></span>${code || '(empty)'}`;
          item.addEventListener('click', () => {
            document.getElementById('zone-filter').value = code;
            document.getElementById('zone-search').value = '';
            Array.from(document.getElementById('zone-filter').options).forEach(opt => opt.style.display = '');
            applyFilter(code);
          });
          div.appendChild(item);
        });
        
        if (displayCodes.length > 40) {
          div.innerHTML += `<div style="color:#888;margin-top:4px">+${displayCodes.length - 40} more‚Ä¶ use search</div>`;
        }
        return div;
      };
      legend.addTo(map);
    }

    // Hash-based deep linking
    function checkHash() {
      if (window.location.hash) {
        const parts = window.location.hash.slice(1).split('/');
        const slug = parts[0];
        const zoneFilter = parts[1] ? decodeURIComponent(parts[1]) : '';
        
        const select = document.getElementById('city-select');
        select.value = slug;
        
        if (cities.length > 0) {
          loadCity(slug);
          if (zoneFilter) {
            // Apply filter after city loads
            setTimeout(() => {
              document.getElementById('zone-filter').value = zoneFilter;
              applyFilter(zoneFilter);
            }, 1500);
          }
        } else {
          setTimeout(checkHash, 300);
        }
      }
    }
    setTimeout(checkHash, 600);
    
    window.addEventListener('hashchange', () => {
      const parts = window.location.hash.slice(1).split('/');
      const slug = parts[0];
      if (slug) {
        document.getElementById('city-select').value = slug;
        loadCity(slug);
      }
    });
  </script>
</body>
</html>
